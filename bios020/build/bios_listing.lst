F00:0001       .include "system.asm"
F01:0001       ;-----------------------------------------------------------------------------
F01:0002       ;Base definitions
F01:0003       ROM_BASE        = $00000000
F01:0004       ROM_SIZE        = $00040000
F01:0005       ROM_TOP         =  ROM_BASE + ROM_SIZE
F01:0006       
F01:0007       RAM_BASE        = $10000000
F01:0008       RAM_SIZE        = $00100000
F01:0009       RAM_TOP         = RAM_BASE + RAM_SIZE
F01:0010       RAM_PAGES       = RAM_SIZE / 1024
F01:0011       
F01:0012       MFP_BASE        = $40000000
F01:0013       
F01:0014       IDE0_BASE	= $20000000
F01:0015       IDE1_BASE	= $30000000
F01:0016       
F01:0017       STACK_INIT	= RAM_TOP
F01:0018       ;-----------------------------------------------------------------------------
F01:0019       ;MFP registers
F01:0020       MFP_GPDR        = MFP_BASE + $00
F01:0021       MFP_AER         = MFP_BASE + $01
F01:0022       MFP_DDR         = MFP_BASE + $02
F01:0023       MFP_IERA        = MFP_BASE + $03
F01:0024       MFP_IERB        = MFP_BASE + $04
F01:0025       MFP_IPRA        = MFP_BASE + $05
F01:0026       MFP_IPRB        = MFP_BASE + $06
F01:0027       MFP_ISRA        = MFP_BASE + $07
F01:0028       MFP_ISRB        = MFP_BASE + $08
F01:0029       MFP_IMRA        = MFP_BASE + $09
F01:0030       MFP_IMRB        = MFP_BASE + $0A
F01:0031       MFP_VR          = MFP_BASE + $0B
F01:0032       MFP_TACR        = MFP_BASE + $0C
F01:0033       MFP_TBCR        = MFP_BASE + $0D
F01:0034       MFP_TCDCR       = MFP_BASE + $0E
F01:0035       MFP_TADR        = MFP_BASE + $0F
F01:0036       MFP_TBDR        = MFP_BASE + $10
F01:0037       MFP_TCDR        = MFP_BASE + $11
F01:0038       MFP_TDDR        = MFP_BASE + $12
F01:0039       MFP_SCR         = MFP_BASE + $13
F01:0040       MFP_UCR         = MFP_BASE + $14
F01:0041       MFP_RSR         = MFP_BASE + $15
F01:0042       MFP_TSR         = MFP_BASE + $16
F01:0043       MFP_UDR         = MFP_BASE + $17
F01:0044       ;-----------------------------------------------------------------------------
F01:0045       ;IDE registers
F01:0046       IDE_D		= IDE0_BASE + $00
F01:0047       IDE_E		= IDE0_BASE + $02 ;read only
F01:0048       IDE_SC		= IDE0_BASE + $04
F01:0049       IDE_SN		= IDE0_BASE + $06
F01:0050       IDE_CL		= IDE0_BASE + $08
F01:0051       IDE_CH		= IDE0_BASE + $0A
F01:0052       IDE_SDH		= IDE0_BASE + $0C
F01:0053       IDE_STAT	= IDE0_BASE + $0E ;read only
F01:0054       IDE_WP		= IDE0_BASE + $02 ;write only
F01:0055       IDE_CMD		= IDE0_BASE + $0E ;write only
F01:0056       
F01:0057       IDE_ASTAT	= IDE1_BASE + $0C ;read only
F01:0058       IDE_DIGO	= IDE1_BASE + $0C ;write only
F01:0059       IDE_DRVA	= IDE1_BASE + $0E ;read only
F01:0060       
F01:0061       IDE_LBAL	= IDE0_BASE + $06
F01:0062       IDE_LBAM	= IDE0_BASE + $08
F01:0063       IDE_LBAH	= IDE0_BASE + $0A
F01:0064       
F00:0002       
F00:0003       org ROM_BASE
F00:0004       
F00:0005       .include "vector.asm"
F02:0001       ;-----------------------------------------------------------------------------
F02:0002       ;exception vector table
F02:0003       dc.l STACK_INIT                 ;Reset Initial Interrupt Stack Pointer
               S01:00000000:  10 10 00 00
F02:0004       dc.l Main                       ;Reset Initial Program Counter
               S01:00000004:  00 00 05 C2
F02:0005       dc.l FatalError                 ;Bus error
               S01:00000008:  00 00 04 00
F02:0006       dc.l FatalError                 ;Address error
               S01:0000000C:  00 00 04 00
F02:0007       
F02:0008       dc.l FatalError                 ;Illigal Instruction
               S01:00000010:  00 00 04 00
F02:0009       dc.l FatalError                 ;Zero Divide
               S01:00000014:  00 00 04 00
F02:0010       dc.l FatalError                 ;CHK, CHK2 Instruction
               S01:00000018:  00 00 04 00
F02:0011       dc.l FatalError                 ;cpTRAPcc, TRAPcc, TRAPV Instructions
               S01:0000001C:  00 00 04 00
F02:0012       
F02:0013       dc.l FatalError                 ;Privilege Violation
               S01:00000020:  00 00 04 00
F02:0014       dc.l IgnoreInterrupt            ;Trace
               S01:00000024:  00 00 04 06
F02:0015       dc.l IgnoreInterrupt            ;Line 1010 Emulator
               S01:00000028:  00 00 04 06
F02:0016       dc.l IgnoreInterrupt            ;Line 1111 Emulator
               S01:0000002C:  00 00 04 06
F02:0017       
F02:0018       dc.l IgnoreInterrupt            ;(Reserved)
               S01:00000030:  00 00 04 06
F02:0019       dc.l FatalError                 ;Coprocessor Protocol Violation
               S01:00000034:  00 00 04 00
F02:0020       dc.l FatalError                 ;Format error
               S01:00000038:  00 00 04 00
F02:0021       dc.l FatalError                 ;Uninitialized Interrupt
               S01:0000003C:  00 00 04 00
F02:0022       
F02:0023       dc.l IgnoreInterrupt            ;(Unasigned)
               S01:00000040:  00 00 04 06
F02:0024       dc.l IgnoreInterrupt            ;(Unasigned)
               S01:00000044:  00 00 04 06
F02:0025       dc.l IgnoreInterrupt            ;(Unasigned)
               S01:00000048:  00 00 04 06
F02:0026       dc.l IgnoreInterrupt            ;(Unasigned)
               S01:0000004C:  00 00 04 06
F02:0027       dc.l IgnoreInterrupt            ;(Unasigned)
               S01:00000050:  00 00 04 06
F02:0028       dc.l IgnoreInterrupt            ;(Unasigned)
               S01:00000054:  00 00 04 06
F02:0029       dc.l IgnoreInterrupt            ;(Unasigned)
               S01:00000058:  00 00 04 06
F02:0030       dc.l IgnoreInterrupt            ;(Unasigned)
               S01:0000005C:  00 00 04 06
F02:0031       
F02:0032       dc.l IgnoreInterrupt            ;Spurious Interrupt
               S01:00000060:  00 00 04 06
F02:0033       dc.l IgnoreInterrupt            ;Level 1 Interrupt Autovector
               S01:00000064:  00 00 04 06
F02:0034       dc.l IgnoreInterrupt            ;Level 2 Interrupt Autovector
               S01:00000068:  00 00 04 06
F02:0035       dc.l IgnoreInterrupt            ;Level 3 Interrupt Autovector
               S01:0000006C:  00 00 04 06
F02:0036       
F02:0037       dc.l IgnoreInterrupt            ;Level 4 Interrupt Autovector
               S01:00000070:  00 00 04 06
F02:0038       dc.l IgnoreInterrupt            ;Level 5 Interrupt Autovector
               S01:00000074:  00 00 04 06
F02:0039       dc.l IgnoreInterrupt            ;Level 6 Interrupt Autovector
               S01:00000078:  00 00 04 06
F02:0040       dc.l IgnoreInterrupt            ;Level 7 Interrupt Autovector
               S01:0000007C:  00 00 04 06
F02:0041       
F02:0042       dc.l IgnoreInterrupt            ;TRAP #0
               S01:00000080:  00 00 04 06
F02:0043       dc.l IgnoreInterrupt            ;TRAP #1
               S01:00000084:  00 00 04 06
F02:0044       dc.l IgnoreInterrupt            ;TRAP #2
               S01:00000088:  00 00 04 06
F02:0045       dc.l IgnoreInterrupt            ;TRAP #3
               S01:0000008C:  00 00 04 06
F02:0046       dc.l IgnoreInterrupt            ;TRAP #4
               S01:00000090:  00 00 04 06
F02:0047       dc.l IgnoreInterrupt            ;TRAP #5
               S01:00000094:  00 00 04 06
F02:0048       dc.l IgnoreInterrupt            ;TRAP #6
               S01:00000098:  00 00 04 06
F02:0049       dc.l IgnoreInterrupt            ;TRAP #7
               S01:0000009C:  00 00 04 06
F02:0050       dc.l IgnoreInterrupt            ;TRAP #8
               S01:000000A0:  00 00 04 06
F02:0051       dc.l IgnoreInterrupt            ;TRAP #9
               S01:000000A4:  00 00 04 06
F02:0052       dc.l IgnoreInterrupt            ;TRAP #10
               S01:000000A8:  00 00 04 06
F02:0053       dc.l IgnoreInterrupt            ;TRAP #11
               S01:000000AC:  00 00 04 06
F02:0054       dc.l IgnoreInterrupt            ;TRAP #12
               S01:000000B0:  00 00 04 06
F02:0055       dc.l IgnoreInterrupt            ;TRAP #13
               S01:000000B4:  00 00 04 06
F02:0056       dc.l IgnoreInterrupt            ;TRAP #14
               S01:000000B8:  00 00 04 06
F02:0057       dc.l IgnoreInterrupt            ;TRAP #15
               S01:000000BC:  00 00 04 06
F02:0058       
F02:0059       dc.l IgnoreInterrupt            ;FPCP Branch or Set on Unordered Condition
               S01:000000C0:  00 00 04 06
F02:0060       dc.l IgnoreInterrupt            ;FPCP Inexact Result
               S01:000000C4:  00 00 04 06
F02:0061       dc.l IgnoreInterrupt            ;FPCP Divide by Zero
               S01:000000C8:  00 00 04 06
F02:0062       dc.l IgnoreInterrupt            ;FPCP Underflow
               S01:000000CC:  00 00 04 06
F02:0063       
F02:0064       dc.l IgnoreInterrupt            ;FPCP Operand error
               S01:000000D0:  00 00 04 06
F02:0065       dc.l IgnoreInterrupt            ;FPCP Overflow
               S01:000000D4:  00 00 04 06
F02:0066       dc.l IgnoreInterrupt            ;FPCP Signaling NAN
               S01:000000D8:  00 00 04 06
F02:0067       dc.l IgnoreInterrupt            ;(Unasigned)
               S01:000000DC:  00 00 04 06
F02:0068       
F02:0069       dc.l IgnoreInterrupt            ;PMMU Configuration
               S01:000000E0:  00 00 04 06
F02:0070       dc.l IgnoreInterrupt            ;PMMU Illigal Operation
               S01:000000E4:  00 00 04 06
F02:0071       dc.l IgnoreInterrupt            ;PMMU Access Level Violation
               S01:000000E8:  00 00 04 06
F02:0072       
F02:0073       dc.l IgnoreInterrupt            ;(Unasigned)
               S01:000000EC:  00 00 04 06
F02:0074       dc.l IgnoreInterrupt            ;(Unasigned)
               S01:000000F0:  00 00 04 06
F02:0075       dc.l IgnoreInterrupt            ;(Unasigned)
               S01:000000F4:  00 00 04 06
F02:0076       dc.l IgnoreInterrupt            ;(Unasigned)
               S01:000000F8:  00 00 04 06
F02:0077       dc.l IgnoreInterrupt            ;(Unasigned)
               S01:000000FC:  00 00 04 06
F02:0078       
F02:0079       dc.l IgnoreInterrupt            ;MFP General Purpose Interrupt 0
               S01:00000100:  00 00 04 06
F02:0080       dc.l IgnoreInterrupt            ;MFP General Purpose Interrupt 1
               S01:00000104:  00 00 04 06
F02:0081       dc.l IgnoreInterrupt            ;MFP General Purpose Interrupt 2
               S01:00000108:  00 00 04 06
F02:0082       dc.l IgnoreInterrupt            ;MFP General Purpose Interrupt 3
               S01:0000010C:  00 00 04 06
F02:0083       dc.l IgnoreInterrupt            ;MFP Timer D
               S01:00000110:  00 00 04 06
F02:0084       dc.l IgnoreInterrupt            ;MFP Timer C
               S01:00000114:  00 00 04 06
F02:0085       dc.l IgnoreInterrupt            ;MFP General Purpose Interrupt 4
               S01:00000118:  00 00 04 06
F02:0086       dc.l IgnoreInterrupt            ;MFP General Purpose Interrupt 5
               S01:0000011C:  00 00 04 06
F02:0087       dc.l IgnoreInterrupt            ;MFP Timer B
               S01:00000120:  00 00 04 06
F02:0088       dc.l IgnoreInterrupt            ;MFP Transmit Error
               S01:00000124:  00 00 04 06
F02:0089       dc.l IgnoreInterrupt            ;MFP Transmit Buffer Empty
               S01:00000128:  00 00 04 06
F02:0090       dc.l IgnoreInterrupt            ;MFP Receive Error
               S01:0000012C:  00 00 04 06
F02:0091       dc.l IgnoreInterrupt            ;MFP Receive Buffer Full
               S01:00000130:  00 00 04 06
F02:0092       dc.l IgnoreInterrupt            ;MFP Timer A
               S01:00000134:  00 00 04 06
F02:0093       dc.l IgnoreInterrupt            ;MFP General Purpose Interrupt 6
               S01:00000138:  00 00 04 06
F02:0094       dc.l IgnoreInterrupt            ;MFP General Purpose Interrupt 7
               S01:0000013C:  00 00 04 06
F02:0095       
F02:0096       dcb.l 176, IgnoreInterrupt      ;User defined Interrupts
F02:0097       ;-----------------------------------------------------------------------------
F02:0098       ;Basic exception handling function
F02:0099       FatalError:			;locks up cpu completely until reset
F02:0100               stop #$0000
               S01:00000400:  4E 72 00 00
F02:0101               bra FatalError
               S01:00000404:  60 FA
F02:0102       
F02:0103       IgnoreInterrupt:		;just returns without doing anything
F02:0104               rte
               S01:00000406:  4E 73
F02:0105       
F00:0006       .include "serial.asm"
F03:0001       ;initializes serial interface and timer D for 9600 baud
F03:0002       SerialInit:
F03:0003       		andi.b #$f0, MFP_TCDCR
               S01:00000408:  02 39 00 F0 40 00 00 0E
F03:0004               	ori.b #$01, MFP_TCDCR
               S01:00000410:  00 39 00 01 40 00 00 0E
F03:0005               	move.b #$30, MFP_TDDR ;TDO at 9600Hz
               S01:00000418:  13 FC 00 30 40 00 00 12
F03:0006       
F03:0007               	move.b #$08, MFP_UCR ;CLK / 1, 8bit char, no parity
               S01:00000420:  13 FC 00 08 40 00 00 14
F03:0008       	        move.b #$04, MFP_TSR ;set h flag
               S01:00000428:  13 FC 00 04 40 00 00 16
F03:0009       	        move.b #$05, MFP_TSR ;enable transmitter
               S01:00000430:  13 FC 00 05 40 00 00 16
F03:0010       
F03:0011       	        move.b #$01, MFP_RSR ;enable receiver
               S01:00000438:  13 FC 00 01 40 00 00 15
F03:0012       
F03:0013       	        move.b #$40, MFP_VR ;MFP interrupt vector base at $40, Automatic end of interrupt mode
               S01:00000440:  13 FC 00 40 40 00 00 0B
F03:0014       	        bset.b #4, MFP_IERA ;enable receive buffer full interrupt
               S01:00000448:  08 F9 00 04 40 00 00 03
F03:0015       	        bset.b #4, MFP_IMRA ;unmask receive buffer full interrupt
               S01:00000450:  08 F9 00 04 40 00 00 09
F03:0016       	        rts
               S01:00000458:  4E 75
F03:0017       
F03:0018       ;writes string to serial
F03:0019       SerialWrite: ;void (char* string)
F03:0020       		move.l (4, A7), A0
               S01:0000045A:  20 6F 00 04
F03:0021       	.loop:
F03:0022       		btst.b #7, MFP_TSR
               S01:0000045E:  08 39 00 07 40 00 00 16
F03:0023               	beq .loop ;as long as the BE flag is clear loop
               S01:00000466:  67 F6
F03:0024       
F03:0025               	cmpi.b #$00, (A0)
               S01:00000468:  4A 10
F03:0026               	beq .return
               S01:0000046A:  67 0A
F03:0027               	move.b (A0)+, MFP_UDR
               S01:0000046C:  13 D8 40 00 00 17
F03:0028               	bra.w .loop
               S01:00000472:  60 00 FF EA
F03:0029               .return:
F03:0030               	rts
               S01:00000476:  4E 75
F03:0031       
F03:0032       ;writes char to serial
F03:0033       SerialWriteChar: ;void (int char)
F03:0034       		btst #7, MFP_TSR
               S01:00000478:  08 39 00 07 40 00 00 16
F03:0035       		beq SerialWriteChar
               S01:00000480:  67 F6
F03:0036       
F03:0037       		move.w (4, A7), D0
               S01:00000482:  30 2F 00 04
F03:0038       		move.b D0, MFP_UDR
               S01:00000486:  13 C0 40 00 00 17
F03:0039       		rts
               S01:0000048C:  4E 75
F03:0040       
F03:0041       __SerialHexTable:
F03:0042       		dc.b "0123456789ABCDEF"
               S01:0000048E:  30 31 32 33 34 35 36 37 38 39 41 42 43 44 45 46
F03:0043       
F03:0044       ;writes 8 bit int to serial as hexadecimal
F03:0045       SerialWriteHex8: ;void (int number)
F03:0046       		move.l __SerialHexTable, A0
               S01:0000049E:  20 78 04 8E
F03:0047       	.loop0:
F03:0048       		btst.b #7, MFP_TSR
               S01:000004A2:  08 39 00 07 40 00 00 16
F03:0049       		beq .loop0
               S01:000004AA:  67 F6
F03:0050       
F03:0051       		move.w (4, A7), D0
               S01:000004AC:  30 2F 00 04
F03:0052       		andi.w #$00f0, D0
               S01:000004B0:  02 40 00 F0
F03:0053       		lsr.b #4, D0
               S01:000004B4:  E8 08
F03:0054       		move.b (0,A0,D0), MFP_UDR
               S01:000004B6:  13 F0 00 00 40 00 00 17
F03:0055       	.loop1:
F03:0056       		btst.b #7, MFP_TSR
               S01:000004BE:  08 39 00 07 40 00 00 16
F03:0057       		beq .loop1
               S01:000004C6:  67 F6
F03:0058       
F03:0059       		move.w (4, A7), D0
               S01:000004C8:  30 2F 00 04
F03:0060       		andi.w #$000f, D0
               S01:000004CC:  02 40 00 0F
F03:0061       		move.b (0,A0,D0), MFP_UDR
               S01:000004D0:  13 F0 00 00 40 00 00 17
F03:0062       
F03:0063       		rts
               S01:000004D8:  4E 75
F03:0064       
F03:0065       ;writes 16 bit int to serial as hexadecimal
F03:0066       SerialWriteHex16: ;void (int number)
F03:0067       		move.w (4, A7), D0
               S01:000004DA:  30 2F 00 04
F03:0068       		andi.w #$ff00, D0
               S01:000004DE:  02 40 FF 00
F03:0069       		lsr.b #8, D0
               S01:000004E2:  E0 08
F03:0070       		move.w D0, -(A7)
               S01:000004E4:  3F 00
F03:0071       		bsr SerialWriteHex8
               S01:000004E6:  61 B6
F03:0072       		addq.l #2, A7
               S01:000004E8:  54 8F
F03:0073       
F03:0074       		move.w (4, A7), D0
               S01:000004EA:  30 2F 00 04
F03:0075       		andi.w #$00ff, D0
               S01:000004EE:  02 40 00 FF
F03:0076       		move.w D0, -(A7)
               S01:000004F2:  3F 00
F03:0077       		bsr SerialWriteHex8
               S01:000004F4:  61 A8
F03:0078       		addq.l #2, A7
               S01:000004F6:  54 8F
F03:0079       
F03:0080       		rts
               S01:000004F8:  4E 75
F03:0081       
F03:0082       ;writes 32 bit int to serial as hexadecimal
F03:0083       SerialWriteHex32: ;void (long number)
F03:0084       		move.w (6, A7), D0
               S01:000004FA:  30 2F 00 06
F03:0085       		move.w D0, -(A7)
               S01:000004FE:  3F 00
F03:0086       		bsr SerialWriteHex16
               S01:00000500:  61 D8
F03:0087       		addq.l #2, A7
               S01:00000502:  54 8F
F03:0088       
F03:0089       		move.w (4, A7), D0
               S01:00000504:  30 2F 00 04
F03:0090       		move.w D0, -(A7)
               S01:00000508:  3F 00
F03:0091       		bsr SerialWriteHex16
               S01:0000050A:  61 CE
F03:0092       		addq.l #2, A7
               S01:0000050C:  54 8F
F03:0093       
F03:0094       		rts
               S01:0000050E:  4E 75
F03:0095       
F03:0096       ;writes 32 bit int to serial as decimal
F03:0097       SerialWriteDec32: ;void (long number)
F03:0098       		move.l (4, A7), D0
               S01:00000510:  20 2F 00 04
F03:0099       		move.l D2, -(A7)
               S01:00000514:  2F 02
F03:0100       		clr.l D2
               S01:00000516:  74 00
F03:0101       		move.l __SerialHexTable, A0
               S01:00000518:  20 78 04 8E
F03:0102       
F03:0103       	.divLoop:
F03:0104       		cmpi.l #0, D0
               S01:0000051C:  4A 80
F03:0105       		beq .display
               S01:0000051E:  67 10
F03:0106       		divul.l #10, D0:D1
               S01:00000520:  4C 7C 10 00 00 00 00 0A
F03:0107       		move.w D0, -(A7)
               S01:00000528:  3F 00
F03:0108       		move.l D1, D0
               S01:0000052A:  20 01
F03:0109       		addq.w #1, D2
               S01:0000052C:  52 42
F03:0110       		bra .divLoop
               S01:0000052E:  60 EC
F03:0111       
F03:0112       	.display:
F03:0113       		cmpi.w #0, D2
               S01:00000530:  4A 42
F03:0114       		beq .return
               S01:00000532:  67 1A
F03:0115       		move.w (A7)+, D0
               S01:00000534:  30 1F
F03:0116       		addi.b #'0', D0
               S01:00000536:  06 00 00 30
F03:0117       	.waitMfp:
F03:0118       		btst.b #7, MFP_TSR
               S01:0000053A:  08 39 00 07 40 00 00 16
F03:0119                       beq .waitMfp
               S01:00000542:  67 F6
F03:0120       		move.b D0, MFP_UDR
               S01:00000544:  13 C0 40 00 00 17
F03:0121       		subq #1, D2
               S01:0000054A:  53 42
F03:0122       		bra .display
               S01:0000054C:  60 E2
F03:0123       
F03:0124       	.return:
F03:0125       		move.l (A7)+, D2
               S01:0000054E:  24 1F
F03:0126       		rts
               S01:00000550:  4E 75
F03:0127       
F03:0128       ;writes 16 bit int to serial as decimal
F03:0129       SerialWriteDec16: ;void (int number)
F03:0130       		clr.l D0
               S01:00000552:  70 00
F03:0131       		move.w (4, A7), D0
               S01:00000554:  30 2F 00 04
F03:0132       		move.l D0, -(A7)
               S01:00000558:  2F 00
F03:0133       		bsr SerialWriteDec32
               S01:0000055A:  61 B4
F03:0134       		addq.l #4, A7
               S01:0000055C:  58 8F
F03:0135       		rts
               S01:0000055E:  4E 75
F03:0136       
F03:0137       ;interrupt handler for serial receiver
F03:0138       SerialRXHandler: ;void ()
F03:0139       		move.l D0, -(A7)
               S01:00000560:  2F 00
F03:0140       		move.l D1, -(A7)
               S01:00000562:  2F 01
F03:0141       		move.l A0, -(A7)
               S01:00000564:  2F 08
F03:0142       
F03:0143       		move.l __SerialRingbuffer, A0
               S01:00000566:  20 79 10 00 00 00
F03:0144       		move.w (__SerialRBWrite), D0
               S01:0000056C:  30 39 10 00 02 02
F03:0145       		move.b MFP_UDR, D1
               S01:00000572:  12 39 40 00 00 17
F03:0146       		andi.w #$00ff, D1
               S01:00000578:  02 41 00 FF
F03:0147       		move.w D1, (0, A0, D0.w*2)
               S01:0000057C:  31 81 02 00
F03:0148       		addq.w #1, D0
               S01:00000580:  52 40
F03:0149       		andi.w #$00ff, D0
               S01:00000582:  02 40 00 FF
F03:0150       		move.w D0, __SerialRBWrite
               S01:00000586:  33 C0 10 00 02 02
F03:0151       
F03:0152       		move.l (A7)+, A0
               S01:0000058C:  20 5F
F03:0153       		move.l (A7)+, D1
               S01:0000058E:  22 1F
F03:0154       		move.l (A7)+, D0
               S01:00000590:  20 1F
F03:0155       		rte
               S01:00000592:  4E 73
F03:0156       
F03:0157       ;returns the number of characters to read from the ringbuffer
F03:0158       SerialAvailable: ;int ()
F03:0159       		move.w (__SerialRBWrite), D0
               S01:00000594:  30 39 10 00 02 02
F03:0160       		move.w (__SerialRBRead), D1
               S01:0000059A:  32 39 10 00 02 00
F03:0161       		sub.w D1, D0
               S01:000005A0:  90 41
F03:0162       		andi.w #$00ff, D0
               S01:000005A2:  02 40 00 FF
F03:0163       		rts
               S01:000005A6:  4E 75
F03:0164       
F03:0165       ;read a character from the ringbuffer, returns zero if buffer empty
F03:0166       SerialRead: ;int ()
F03:0167       		bsr SerialAvailable
               S01:000005A8:  61 EA
F03:0168       		cmp.w #0, D0
               S01:000005AA:  4A 40
F03:0169       		beq .return ;no data in the buffer, return
               S01:000005AC:  67 10
F03:0170       
F03:0171       		move.w (__SerialRBRead), D0
               S01:000005AE:  30 39 10 00 02 00
F03:0172       		move.l __SerialRingbuffer, A0
               S01:000005B4:  20 79 10 00 00 00
F03:0173       		move.w (0, A0, D0.w*2), D0
               S01:000005BA:  30 30 02 00
F03:0174       
F03:0175       	.return:
F03:0176       		rts
               S01:000005BE:  4E 75
F03:0177       
F00:0007       .include "ide.asm"
F04:0001       IdeInit:
F04:0002       		rts
               S01:000005C0:  4E 75
F04:0003       
F00:0008       
F00:0009       Main:
F00:0010       		jsr SerialInit
               S01:000005C2:  4E B8 04 08
F00:0011       		move.l #.text0, -(A7)
               S01:000005C6:  2F 3C 00 00 05 EC
F00:0012       		jsr SerialWrite
               S01:000005CC:  4E B8 04 5A
F00:0013       		addq.l #4, A7
               S01:000005D0:  58 8F
F00:0014       		bsr getBootblockCount
               S01:000005D2:  61 00 01 46
F00:0015       		move.w D0, D2 ;move bootblock count to trash proof register
               S01:000005D6:  34 00
F00:0016       		jsr SerialWriteDec16
               S01:000005D8:  4E B8 05 52
F00:0017       		move.w '\n', -(A7)
               S01:000005DC:  3F 38 00 0A
F00:0018       		jsr SerialWriteChar
               S01:000005E0:  4E B8 04 78
F00:0019       		addq.l #2, A7
               S01:000005E4:  54 8F
F00:0020       
F00:0021       	.loop:
F00:0022       		bra.l .loop
               S01:000005E6:  60 FF FF FF FF FE
F00:0023       
F00:0024       	.text0:
F00:0025       	;ascii text font Doom (www.coolgenerator.com/ascii-text-generator)
F00:0026       		dc.b "\n\n"
               S01:000005EC:  0A 0A
F00:0027       		dc.b "______ _____ _____ _____  _____  _____  _____\n"
               S01:000005EE:  5F 5F 5F 5F 5F 5F 20 5F 5F 5F 5F 5F 20 5F 5F 5F
               S01:000005FE:  5F 5F 20 5F 5F 5F 5F 5F 20 20 5F 5F 5F 5F 5F 20
F00:0028       		dc.b "| ___ \\_   _|  _  /  ___||  _  |/ __  \\|  _  |\n"
               S01:0000061C:  7C 20 5F 5F 5F 20 5C 5F 20 20 20 5F 7C 20 20 5F
               S01:0000062C:  20 20 2F 20 20 5F 5F 5F 7C 7C 20 20 5F 20 20 7C
F00:0029       		dc.b "| |_/ / | | | | | \\ `--. | |/' |`' / /'| |/' |\n"
               S01:0000064B:  7C 20 7C 5F 2F 20 2F 20 7C 20 7C 20 7C 20 7C 20
               S01:0000065B:  7C 20 5C 20 60 2D 2D 2E 20 7C 20 7C 2F 27 20 7C
F00:0030       		dc.b "| ___ \\ | | | | | |`--. \\|  /| |  / /  |  /| |\n"
               S01:0000067A:  7C 20 5F 5F 5F 20 5C 20 7C 20 7C 20 7C 20 7C 20
               S01:0000068A:  7C 20 7C 60 2D 2D 2E 20 5C 7C 20 20 2F 7C 20 7C
F00:0031       		dc.b "| |_/ /_| |_\\ \\_/ /\\__/ /\\ |_/ /./ /___\\ |_/ /\\\n"
               S01:000006A9:  7C 20 7C 5F 2F 20 2F 5F 7C 20 7C 5F 5C 20 5C 5F
               S01:000006B9:  2F 20 2F 5C 5F 5F 2F 20 2F 5C 20 7C 5F 2F 20 2F
F00:0032       		dc.b "\\____/ \\___/ \\___/\\____/  \\___/ \\_____/ \\___/"
               S01:000006D9:  5C 5F 5F 5F 5F 2F 20 5C 5F 5F 5F 2F 20 5C 5F 5F
               S01:000006E9:  5F 2F 5C 5F 5F 5F 5F 2F 20 20 5C 5F 5F 5F 2F 20
F00:0033       		dc.b "\n\n"
               S01:00000706:  0A 0A
F00:0034       		dc.b "Bootblocks found:", $00
               S01:00000708:  42 6F 6F 74 62 6C 6F 63 6B 73 20 66 6F 75 6E 64
               S01:00000718:  3A
               S01:00000719:  00
F00:0035       
F00:0036       getBootblockCount:
F00:0037       		move.w #12345, D0
               S01:0000071A:  30 3C 30 39
F00:0038       		rts
               S01:0000071E:  4E 75
F00:0039       
F00:0040       
F00:0041       BIOS_END:
F00:0042       ;Alignment hack because madmac does not support alignment to an arbitary size
F00:0043       ;This align is needed because right after the bios follows the first bootblock but that has to be aligned to 256 bytes b
F00:0044       ;(actually 128 bytes per page but because we use two eeproms (29ee010) in tandem the page size is twice as large)
F00:0045       ;If the target to compile to has a different page size this has to be changed
F00:0046       ;I advice not to look at this code for to long. If it works dont change it...
F00:0047       if ((BIOS_END & $ff) != 0) ;check if alligned to 256 byte boundry
F00:0048       	ds.b 256 - (BIOS_END & $ff) ;if not alligned then add filler
F00:0049       endif
F00:0050       print "BIOS_END: ", /d/l BIOS_END
F00:0051       
F00:0052       FIRST_BOOTBLOCK:
F00:0053       ;the first bootblock starts here
F00:0054       print "FIRST_BOOTBLOCK: ", /d/l FIRST_BOOTBLOCK
F00:0055       print "Filled bytes: ", /d FIRST_BOOTBLOCK - BIOS_END
F00:0056       
F00:0057       .include "ramdefs.asm"
F05:0001       abs RAM_BASE
F05:0002       
F05:0003       __SerialRingbuffer: ;clean ringbuffer
F05:0004       		ds.w 256
F05:0005       __SerialRBRead: ;read index into ringbuffer
F05:0006       		ds.w 1
F05:0007       __SerialRBWrite: ;write index into ringbuffer
F05:0008       		ds.w 1
F05:0009       
F00:0058       


Sections:
S01  seg0


Sources:
F00  main.asm
F01  system.asm
F02  vector.asm
F03  serial.asm
F04  ide.asm
F05  ramdefs.asm


Symbols:
FIRST_BOOTBLOCK EXPR(2048=0x800) ABS 
BIOS_END EXPR(1824=0x720) ABS 
 Main .loop EXPR(1510=0x5e6) ABS 
getBootblockCount EXPR(1818=0x71a) ABS 
 Main .text0 EXPR(1516=0x5ec) ABS 
IdeInit EXPR(1472=0x5c0) UNUSED ABS 
 SerialRead .return EXPR(1470=0x5be) ABS 
SerialRead EXPR(1448=0x5a8) UNUSED ABS 
__SerialRBRead EXPR(268435968=0x10000200) 
SerialAvailable EXPR(1428=0x594) ABS 
__SerialRBWrite EXPR(268435970=0x10000202) 
__SerialRingbuffer EXPR(268435456=0x10000000) 
SerialRXHandler EXPR(1376=0x560) UNUSED ABS 
SerialWriteDec16 EXPR(1362=0x552) ABS 
 SerialWriteDec32 .waitMfp EXPR(1338=0x53a) ABS 
 SerialWriteDec32 .return EXPR(1358=0x54e) ABS 
 SerialWriteDec32 .display EXPR(1328=0x530) ABS 
 SerialWriteDec32 .divLoop EXPR(1308=0x51c) ABS 
SerialWriteDec32 EXPR(1296=0x510) ABS 
SerialWriteHex32 EXPR(1274=0x4fa) UNUSED ABS 
SerialWriteHex16 EXPR(1242=0x4da) ABS 
 SerialWriteHex8 .loop1 EXPR(1214=0x4be) ABS 
 SerialWriteHex8 .loop0 EXPR(1186=0x4a2) ABS 
SerialWriteHex8 EXPR(1182=0x49e) ABS 
__SerialHexTable EXPR(1166=0x48e) ABS 
SerialWriteChar EXPR(1144=0x478) ABS 
 SerialWrite .return EXPR(1142=0x476) ABS 
 SerialWrite .loop EXPR(1118=0x45e) ABS 
SerialWrite EXPR(1114=0x45a) ABS 
SerialInit EXPR(1032=0x408) ABS 
IgnoreInterrupt EXPR(1030=0x406) ABS 
FatalError EXPR(1024=0x400) ABS 
Main EXPR(1474=0x5c2) ABS 
IDE_LBAH EXPR(536870922=0x2000000a) UNUSED EQU 
IDE_LBAM EXPR(536870920=0x20000008) UNUSED EQU 
IDE_LBAL EXPR(536870918=0x20000006) UNUSED EQU 
IDE_DRVA EXPR(805306382=0x3000000e) UNUSED EQU 
IDE_DIGO EXPR(805306380=0x3000000c) UNUSED EQU 
IDE_ASTAT EXPR(805306380=0x3000000c) UNUSED EQU 
IDE_CMD EXPR(536870926=0x2000000e) UNUSED EQU 
IDE_WP EXPR(536870914=0x20000002) UNUSED EQU 
IDE_STAT EXPR(536870926=0x2000000e) UNUSED EQU 
IDE_SDH EXPR(536870924=0x2000000c) UNUSED EQU 
IDE_CH EXPR(536870922=0x2000000a) UNUSED EQU 
IDE_CL EXPR(536870920=0x20000008) UNUSED EQU 
IDE_SN EXPR(536870918=0x20000006) UNUSED EQU 
IDE_SC EXPR(536870916=0x20000004) UNUSED EQU 
IDE_E EXPR(536870914=0x20000002) UNUSED EQU 
IDE_D EXPR(536870912=0x20000000) UNUSED EQU 
MFP_UDR EXPR(1073741847=0x40000017) EQU 
MFP_TSR EXPR(1073741846=0x40000016) EQU 
MFP_RSR EXPR(1073741845=0x40000015) EQU 
MFP_UCR EXPR(1073741844=0x40000014) EQU 
MFP_SCR EXPR(1073741843=0x40000013) UNUSED EQU 
MFP_TDDR EXPR(1073741842=0x40000012) EQU 
MFP_TCDR EXPR(1073741841=0x40000011) UNUSED EQU 
MFP_TBDR EXPR(1073741840=0x40000010) UNUSED EQU 
MFP_TADR EXPR(1073741839=0x4000000f) UNUSED EQU 
MFP_TCDCR EXPR(1073741838=0x4000000e) EQU 
MFP_TBCR EXPR(1073741837=0x4000000d) UNUSED EQU 
MFP_TACR EXPR(1073741836=0x4000000c) UNUSED EQU 
MFP_VR EXPR(1073741835=0x4000000b) EQU 
MFP_IMRB EXPR(1073741834=0x4000000a) UNUSED EQU 
MFP_IMRA EXPR(1073741833=0x40000009) EQU 
MFP_ISRB EXPR(1073741832=0x40000008) UNUSED EQU 
MFP_ISRA EXPR(1073741831=0x40000007) UNUSED EQU 
MFP_IPRB EXPR(1073741830=0x40000006) UNUSED EQU 
MFP_IPRA EXPR(1073741829=0x40000005) UNUSED EQU 
MFP_IERB EXPR(1073741828=0x40000004) UNUSED EQU 
MFP_IERA EXPR(1073741827=0x40000003) EQU 
MFP_DDR EXPR(1073741826=0x40000002) UNUSED EQU 
MFP_AER EXPR(1073741825=0x40000001) UNUSED EQU 
MFP_GPDR EXPR(1073741824=0x40000000) UNUSED EQU 
STACK_INIT EXPR(269484032=0x10100000) EQU 
IDE1_BASE EXPR(805306368=0x30000000) EQU 
IDE0_BASE EXPR(536870912=0x20000000) EQU 
MFP_BASE EXPR(1073741824=0x40000000) EQU 
RAM_PAGES EXPR(1024=0x400) UNUSED EQU 
RAM_TOP EXPR(269484032=0x10100000) EQU 
RAM_SIZE EXPR(1048576=0x100000) EQU 
RAM_BASE EXPR(268435456=0x10000000) EQU 
ROM_TOP EXPR(262144=0x40000) UNUSED EQU 
ROM_SIZE EXPR(262144=0x40000) EQU 
ROM_BASE EXPR(0=0x0) EQU 
_MOVEMBYTES EXPR(0=0x0) INTERNAL 
 MOVEMSIZE EXPR(0=0x0) INTERNAL 
_MOVEMREGS EXPR(0=0x0) INTERNAL 
__VASM EXPR(4=0x4) INTERNAL 
__UNIXFS EXPR(0=0x0) INTERNAL 

There have been no errors.
